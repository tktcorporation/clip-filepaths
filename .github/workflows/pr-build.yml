name: PR Build Check

permissions:
  contents: read

on:
  pull_request:
    branches:
      - main
    # paths:
    #   - 'src/**'
    #   - 'native/**'
    #   - 'npm/**'
    #   - 'package.json'
    #   - 'pnpm-lock.yaml'
    #   - 'Cargo.toml'
    #   - 'Cargo.lock'

jobs:
  # 各プラットフォーム向けのバイナリをビルド
  build-binaries:
    name: バイナリビルド (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false  # 一つのビルドが失敗しても他を続行
      matrix:
        include:
          - name: linux-x64-gnu # napi naming convention
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            arch: x64
          - name: darwin-x64 # napi naming convention
            os: macos-latest
            target: x86_64-apple-darwin
            arch: x64
          - name: darwin-arm64 # napi naming convention
            os: macos-latest
            target: aarch64-apple-darwin
            arch: arm64
          - name: win32-x64-msvc # napi naming convention
            os: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x64
          - name: win32-arm64-msvc
            os: windows-latest
            target: aarch64-pc-windows-msvc
            arch: arm64

    steps:
      - uses: actions/checkout@v3

      # macOSでのクロスコンパイル設定を確認
      - name: macOSクロスコンパイル環境確認
        if: startsWith(matrix.os, 'macos')
        shell: bash
        run: |
          echo "macOS アーキテクチャ: $(uname -m)"
          echo "Xcode情報:"
          xcodebuild -version
          xcrun --show-sdk-path
          echo "ターゲット: ${{ matrix.target }}"
          
          if [[ "${{ matrix.target }}" == "x86_64-apple-darwin" && "$(uname -m)" == "arm64" ]]; then
            echo "ARM64からx86_64へのクロスコンパイル設定が必要です"
            xcrun --find clang
          fi

      # Use the new composite action for building
      - name: Build Native Module
        uses: ./.github/actions/build-native-module
        with:
          name: ${{ matrix.name }}
          os: ${{ matrix.os }}
          target: ${{ matrix.target }}
          artifact-name-prefix: 'pr-binaries'
          arch: ${{ matrix.arch }}

      # --- Removed Steps (now inside the composite action) ---
      # - name: Rustツールチェインのセットアップ
      #   uses: actions-rs/toolchain@v1
      #   ...
      # - name: Rustターゲットの追加
      #   run: rustup target add ${{ matrix.target }}
      # - name: Node.js設定
      #   uses: ./.github/actions/node-setup
      #   ...
      # - name: Linux 依存関係のインストールと設定
      #   if: startsWith(matrix.os, 'ubuntu')
      #   ...
      # - name: napi-rs CLI セットアップ
      #   run: npm install -g @napi-rs/cli
      # - name: バイナリビルド (napi build)
      #   run: |
      #     ...
      #     napi build --platform --release --target ${{ matrix.target }}
      # - name: 成果物移動 (.node)
      #   run: |
      #     ...
      # - name: 成果物を収集
      #   run: |
      #     ...
      # - name: 成果物をアップロード
      #   uses: actions/upload-artifact@v4
      #   ...

  # ビルド結果の検証
  verify-binaries:
    name: バイナリ検証
    needs: build-binaries
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Node.js設定
        uses: ./.github/actions/node-setup
        with:
          node-version: ''
          package-path: '.'
      
      # ビルド成果物をダウンロード
      - name: 成果物をダウンロード
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: pr-binaries-*
          merge-multiple: true
      
      # 成果物を正しい場所にコピー
      - name: 成果物を配置
        shell: bash
        run: |
          echo "Downloaded artifacts contents:"
          ls -lR artifacts
          # Copy all found .node files from the downloaded artifacts to the current directory
          # The verify-binaries.js script should look for them here
          echo "Copying .node files to root..."
          find artifacts -name '*.node' -exec cp {} . \;
          echo "Files in root directory after copy:"
          ls -la *.node

          # npmディレクトリに.nodeファイルをコピー
          echo "Copying .node files to npm directory..."
          mkdir -p npm
          find . -maxdepth 1 -name "*.node" -exec cp {} npm/ \;
          echo "Files in npm directory after copy:"
          ls -la npm/*.node || echo "No files found in npm directory"
      
      # バイナリ検証
      - name: バイナリ検証
        run: |
          echo "見つかった.nodeファイルの一覧:"
          find . -type f -name "*.node" | tee found_binaries.txt
          FOUND_COUNT=$(cat found_binaries.txt | wc -l)
          echo "見つかったバイナリ数: $FOUND_COUNT"
          if [ $FOUND_COUNT -eq 0 ]; then
            echo "エラー: バイナリが1つも見つかりません！"
            exit 1
          fi
          echo "検証を実行します..."
          node scripts/verify-binaries.js || {
            echo "警告: バイナリ検証で一部問題が見つかりました"
            exit 1
          } 